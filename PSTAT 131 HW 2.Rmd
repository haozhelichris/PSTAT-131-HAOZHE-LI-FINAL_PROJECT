---
title: "Homework 2"
author: "PSTAT 131/231"
output:
    html_document:
      toc: true
      toc_float: true
      code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      warning = FALSE)
```

```{r}
library(ggplot2)
library(tidyverse)
library(tidymodels)
library(corrplot)
library(ggthemes)
tidymodels_prefer()
```

## Linear Regression

The age of an abalone is typically determined by cutting the shell open and counting the number of rings with a microscope. The purpose of this data set is to determine whether abalone age (**number of rings + 1.5**) can be accurately predicted using other, easier-to-obtain information about the abalone.

The full abalone data set is located in the `\data` subdirectory. Read it into *R* using `read_csv()`. Take a moment to read through the codebook (`abalone_codebook.txt`) and familiarize yourself with the variable definitions.

Make sure you load the `tidyverse` and `tidymodels`!

### Question 1
```{r}
data1 <- read.csv("/Users/lhz/Desktop/---/PSTAT-131-HAOZHE-LI-HW-1/abalone.csv")
View(data1)
attach(data1)
input <- data1[,c('type','longest_shell','diameter','height','whole_weight','shucked_weight','viscera_weight','shell_weight','rings')]
data2 <- data.frame(type = type, longest_shell=longest_shell, diameter=diameter, height=height, whole_weight=whole_weight, shucked_weight=shucked_weight,viscera_weight=viscera_weight,shell_weight=shell_weight,rings=rings,age=rings+1.5)
View(data2)
attach(data2)
```

Your goal is to predict abalone age, which is calculated as the number of rings plus 1.5. Notice there currently is no `age` variable in the data set. Add `age` to the data set.

Assess and describe the distribution of `age`.
```{r}
class(data1$age)
p <- ggplot(data = data2, aes(x=age)) + geom_histogram(binwidth = 2.5) +xlab("Frenquency")+ylab("Abalone Age")
p
```
Most of the abalone age is around 10 years and barely abalone  which age is over 20 years and also there are barely abalone are below 5 years

### Question 2

Split the abalone data into a training set and a testing set. Use stratified sampling. You should decide on appropriate percentages for splitting the data.

*Remember that you'll need to set a seed at the beginning of the document to reproduce your results.*

```{r}
set.seed(3435)

abalone_split <- initial_split(data2, prop = 0.80)
abalone_train <- training(abalone_split)
abalone_test <- testing(abalone_split)
```

### Question 3

Using the **training** data, create a recipe predicting the outcome variable, `age`, with all other predictor variables. Note that you should not include `rings` to predict `age`. Explain why you shouldn't use `rings` to predict `age`.

Steps for your recipe:

1.  dummy code any categorical predictors
```{r}
abalone_recipe <- recipe(age ~ type + longest_shell + diameter + height + whole_weight + shucked_weight + viscera_weight + shell_weight, data = abalone_train) %>% 
  step_dummy(all_nominal_predictors())
```
Because we already set the relationship between rings and age which is age=rings+1.5 so we dont need to predict it

2.  create interactions between

    -   `type` and `shucked_weight`,
    -   `longest_shell` and `diameter`,
    -   `shucked_weight` and `shell_weight`
    
3.  center all predictors, and

4.  scale all predictors.

You'll need to investigate the `tidymodels` documentation to find the appropriate step functions to use.

```{r}
int_mod_1 <- abalone_recipe  %>%
    step_interact(terms = ~ type:shucked_weight)
int_mod_1 <- abalone_recipe  %>%
    step_interact(terms = ~ longest_shell:diameter)
int_mod_1 <- abalone_recipe  %>%
    step_interact(terms = ~ shucked_weight:shell_weight)
abalone_train_scale <- abalone_train %>% mutate(across(where(is.numeric),scale))
abalone_train_scale2 <- subset(abalone_train_scale, select=-c(rings))
abalone_train_scale_r <- recipe(age ~ ., data = abalone_train_scale2) %>% 
  step_dummy(all_nominal_predictors())
abalone_train_scale2
```

### Question 4

Create and store a linear regression object using the `"lm"` engine.
```{r}
lm_model <- linear_reg() %>% 
  set_engine("lm")
```


### Question 5

Now:

1.  set up an empty workflow,
2.  add the model you created in Question 4, and
3.  add the recipe that you created in Question 3.

```{r}
lm_wflow <- workflow() %>% 
  add_model(lm_model) %>% 
  add_recipe(abalone_train_scale_r)

lm_fit <- fit(lm_wflow, abalone_train)
```

```{r}
lm_fit %>% 
  extract_fit_parsnip() %>% 
  tidy()
```
### Question 6

Use your `fit()` object to predict the age of a hypothetical female abalone with longest_shell = 0.50, diameter = 0.10, height = 0.30, whole_weight = 4, shucked_weight = 1, viscera_weight = 2, shell_weight = 1.

```{r}
variable <- data.frame(type='F', longest_shell = 0.50, diameter = 0.10, height = 0.30, whole_weight = 4, shucked_weight = 1, viscera_weight = 2, shell_weight = 1)
predict(lm_fit, new_data = variable)
```
### Question 7

Now you want to assess your model's performance. To do this, use the `yardstick` package:

1.  Create a metric set that includes *R^2^*, RMSE (root mean squared error), and MAE (mean absolute error).
2.  Use `predict()` and `bind_cols()` to create a tibble of your model's predicted values from the **training data** along with the actual observed ages (these are needed to assess your model's performance).
3.  Finally, apply your metric set to the tibble, report the results, and interpret the *R^2^* value.
```{r}
library(dplyr)
library(yardstick)
multi_metric <- metric_set(rsq, rmse, mae)
prediction<-predict(lm_fit, new_data = abalone_train)
prediction_table <- bind_cols(abalone_train$age, prediction, id=NULL)
colnames(prediction_table)[1] = "Age of the Abalone"
colnames(prediction_table)[2] = "Estimate"
prediction_table

abalone_train %>%
  multi_metric(truth=prediction_table$`Age of the Abalone`, estimate=prediction_table$Estimate)
```
So the R^2 is 0.5327456 which means  53.27456% of the data fit the model.